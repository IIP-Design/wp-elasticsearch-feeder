!function(){"use strict";var e=window.wp.i18n;const t=t=>"string"!=typeof t?t:(0,e.__)(t,"gpalab-feeder"),n=(e,t)=>{const n=document.getElementById(t),a="string"==typeof e?e:JSON.stringify(e,null,2);n.textContent=a||""},a=e=>{const t=document.getElementById(e);for(;t.firstChild;)t.removeChild(t.firstChild)},o=e=>{document.querySelectorAll(".inside.manage-btns button").forEach((t=>{t.disabled=e}))},r=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"block";const a=document.getElementById(e);a.style.display=t?n:"none"},l=e=>{const t="gpalab-growl";e&&(n(e,t),r(t,!0),setTimeout((()=>{r(t,!1),a(t)}),1500))},s=e=>{const n=t("seconds ago (typically updates every 60 seconds)");document.getElementById("gpalab-feeder-last-heartbeat").innerHTML=`${e} ${n}`},d=()=>{var e,t;return null===(e=window)||void 0===e||null===(t=e.gpalabFeederSettings)||void 0===t?void 0:t.feederNonce},c=()=>{var e;return null===(e=window)||void 0===e?void 0:e.ajaxurl},i=(e,t,n,a,o)=>{const r=o||(()=>{});fetch(c(),{method:t,body:e}).then((e=>e.json())).then((e=>{n(e)})).catch((e=>{a(e)})).finally((()=>r()))},p=(e,t,n,a,o,r)=>{const l=o||(()=>{}),s=new AbortController,{signal:d}=s;((e,t)=>new Promise(((n,a)=>{const o=setTimeout((()=>{a(new Error("Request timed out."))}),e);t.then(n,a).finally((()=>clearTimeout(o)))})))(r,fetch(c(),{method:t,body:e,signal:d})).then((e=>e.json())).then((e=>{n(e)})).catch((e=>{a(e),s.abort()})).finally((()=>l()))},u=()=>{o(!1)},g="log-text",m=async()=>{o(!0);const e=new FormData;e.append("action","gpalab_feeder_clear_logs"),e.append("security",d()),i(e,"POST",(()=>{a(g),l(t("Logs cleared."))}),(e=>{console.error(e),l(t("Communication error while clearing logs."))}),u)},y=async()=>{a(g);const e=new FormData;e.append("action","gpalab_feeder_reload_log"),e.append("security",d());const t=e=>{n(e,g)};i(e,"POST",t,t,u)},b={lastHeartbeat:null,heartbeatTimer:null,clear(){this.lastHeartbeat=0,clearInterval(this.heartbeatTimer)},increment(){this.lastHeartbeat+=2},get beat(){return this.lastHeartbeat},get timer(){return this.heartbeatTimer},set newTimer(e){this.heartbeatTimer=e}},f=(e,t)=>{t.gpalab_feeder_count=1},h=()=>{b.clear(),s(b.beat),b.newTimer=setInterval((()=>{b.increment(),s(b.beat)}),2e3)},E=(e,t)=>{var n;h(),t.gpalab_feeder_count&&(n=t.gpalab_feeder_count,document.querySelectorAll(".status-count").forEach((e=>{const{statusId:t}=e.dataset,a=e.textContent,o=n[t]||0;o!==a&&(e.style.opacity=0,e.textContent=o,e.style.opacity=1)})))},v=(e,t)=>{const o="index-spinner-text";t&&(a(o),n(t,o)),r("index-spinner",e)},w=e=>{e.results=null,e.post=null,e.complete=0,v(!1),r("progress-bar",!1),a("index-spinner-count"),document.getElementById("progress-bar-span").style.width=0},_=e=>{const t="progress-bar";r(t,!0),e&&document.getElementById(t).classList.add("paused")},I=e=>{n(`${e.complete} / ${e.total}`,"index-spinner-count"),document.getElementById("progress-bar-span").style.width=e.complete/e.total*100+"%"},T="gpalab-feeder-output",B=()=>{o(!1),v(!1)},S=(e,t)=>{const{complete:a,done:o,error:r,message:l,response:s,results:c,total:p}=t;if(c){const e=c.length>0?JSON.stringify(c,null,2):"No errors.";n(e,T)}else s&&((e,t)=>{const n=document.getElementById("gpalab-feeder-output"),a=document.createElement("p"),o="string"==typeof e?e:JSON.stringify(e,null,2);a.textContent=o||"",n.insertBefore(a,n.firstChild)})(JSON.stringify(s,null,2));r||o?(l&&(n(l,T),y()),w(e),B()):(e.complete=a,e.total=p,s?(e.post=s.req,e.results=null):c?(e.results=c,e.post=null):(e.results=null,e.post=null),(async e=>{if(v(!0,"Processing... Leaving this page will pause the resync."),e.paused)return;const t=new FormData;t.append("action","gpalab_feeder_next"),t.append("security",d()),i(t,"POST",(t=>{I(e),S(e,t)}),(e=>{n(e,T)}))})(e),I(e))},x=async(e,r)=>{a(T),w(e),(()=>{const e=document.getElementById("gpalab-feeder-notice");e&&null!==e.parentNode&&e.parentNode.removeChild(e)})(),o(!0);const l=t(r?"Fixing errors...":"Initiating new resync.");v(!0,l),_();const s=new FormData;s.append("action","gpalab_feeder_sync_init"),s.append("security",d()),s.append("sync_errors",r),s.append("method","GET"),p(s,"POST",(t=>{S(e,t)}),(t=>{n(t,T),w(e)}),null,12e4)},L=async()=>{const e="gpalab-feeder-output",r=document.getElementById("gpalab-feeder-url-input");v(!0,t("Testing connection...")),a(e),o(!0);const l=new FormData;l.append("action","gpalab_feeder_test"),l.append("security",d()),l.append("url",r.value),l.append("method","GET");const s=t=>{n(t,e)};i(l,"POST",s,s,(()=>{o(!1),v(!1)}))};(e=>{if("loading"!==document.readyState)return e();document.addEventListener("DOMContentLoaded",e)})((()=>{const e={total:0,complete:0,post:null,paused:!1,results:null};(e=>{const{syncTotals:t}=window.gpalabFeederSettings;e.total=parseInt(t.total,10),e.complete=parseInt(t.complete,10),e.paused=t.paused,e.paused&&(w(e),_(e.paused))})(e),(e=>{const r=document.getElementById("gpalab-feeder-clear-logs"),l=document.getElementById("gpalab-feeder-test-connection"),s=document.getElementById("gpalab-feeder-resync"),c=document.getElementById("gpalab-feeder-fix-errors"),i=document.getElementById("gpalab-feeder-resync-control"),u=document.getElementById("gpalab-feeder-validate-sync"),g=document.getElementById("gpalab-feeder-reload-log");r.addEventListener("click",m),l.addEventListener("click",L),s.addEventListener("click",(()=>x(e,!1))),c.addEventListener("click",(()=>x(e,!0))),i.addEventListener("click",i),u.addEventListener("click",(()=>(async()=>{a(T),v(!0,t("Validating...")),o(!0);const e=new FormData;e.append("action","gpalab_feeder_validate"),e.append("security",d());const r=e=>{n(e,T)};p(e,"POST",r,r,B,12e4)})())),g.addEventListener("click",y),jQuery(document).on("heartbeat-send",f),jQuery(document).on("heartbeat-tick",E),h()})(e)}))}();