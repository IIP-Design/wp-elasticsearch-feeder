!function(){"use strict";var e=window.wp.i18n;const t=t=>"string"!=typeof t?t:(0,e.__)(t,"gpalab-feeder"),n=(e,t)=>{const n=document.getElementById(t),a="string"==typeof e?e:JSON.stringify(e,null,2);n.textContent=a||""},a=e=>{const t=document.getElementById(e);for(;t.firstChild;)t.removeChild(t.firstChild)},s=e=>{document.querySelectorAll(".inside.manage-btns button").forEach((t=>{t.disabled=e}))},r=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"block";const a=document.getElementById(e);a.style.display=t?n:"none"},o=e=>{const t="gpalab-growl";e&&(n(e,t),r(t,!0),setTimeout((()=>{r(t,!1),a(t)}),1500))},l=e=>{const n=t("seconds ago (typically updates every 60 seconds)");document.getElementById("gpalab-feeder-last-heartbeat").innerHTML=`${e} ${n}`},d=()=>{var e,t;return null===(e=window)||void 0===e||null===(t=e.gpalabFeederSettings)||void 0===t?void 0:t.feederNonce},c=()=>{var e;return null===(e=window)||void 0===e?void 0:e.ajaxurl},i=(e,t,n,a,s)=>{const r=s||(()=>{});fetch(c(),{method:t,body:e}).then((e=>e.json())).then((e=>{n(e)})).catch((e=>{a(e)})).finally((()=>r()))},u=(e,t,n,a,s,r)=>{const o=s||(()=>{}),l=new AbortController,{signal:d}=l;((e,t)=>new Promise(((n,a)=>{const s=setTimeout((()=>{a(new Error("Request timed out."))}),e);t.then(n,a).finally((()=>clearTimeout(s)))})))(r,fetch(c(),{method:t,body:e,signal:d})).then((e=>e.json())).then((e=>{n(e)})).catch((e=>{a(e),l.abort()})).finally((()=>o()))},p=()=>{s(!1)},g="log-text",m=async()=>{s(!0);const e=new FormData;e.append("action","gpalab_feeder_clear_logs"),e.append("security",d()),i(e,"POST",(()=>{a(g),o(t("Logs cleared."))}),(e=>{console.error(e),o(t("Communication error while clearing logs."))}),p)},y=async()=>{a(g);const e=new FormData;e.append("action","gpalab_feeder_reload_log"),e.append("security",d());const t=e=>{n(e,g)};i(e,"POST",t,t,p)},b={lastHeartbeat:null,heartbeatTimer:null,clear(){this.lastHeartbeat=0,clearInterval(this.heartbeatTimer)},increment(){this.lastHeartbeat+=2},get beat(){return this.lastHeartbeat},get timer(){return this.heartbeatTimer},set newTimer(e){this.heartbeatTimer=e}},f=(e,t)=>{t.gpalab_feeder_count=1},h=()=>{b.clear(),l(b.beat),b.newTimer=setInterval((()=>{b.increment(),l(b.beat)}),2e3)},v=(e,t)=>{var n;h(),t.gpalab_feeder_count&&(n=t.gpalab_feeder_count,document.querySelectorAll(".status-count").forEach((e=>{const{statusId:t}=e.dataset,a=e.textContent,s=n[t]||0;s!==a&&(e.style.opacity=0,e.textContent=s,e.style.opacity=1)})))},E=(e,t)=>{const s="index-spinner-text";t&&(a(s),n(t,s)),r("index-spinner",e)},w=e=>{e.results=null,e.post=null,E(!1),r("progress-bar",!1)},_=e=>{const n=t(e?"Paused.":"Processing... Leaving this page will pause the resync.");E(!0,n);const a="progress-bar";r(a,!0),e&&document.getElementById(a).classList.add("paused")},T="gpalab-feeder-output",I=()=>{s(!1),E(!1)},B=(e,t)=>{if(console.log("handleQueueResult: ",t),t.error||t.done?(w(e),t.error&&t.message&&n(t.message,T)):(e.complete=t.complete,e.total=t.total,t.response?(e.post=t.response.req,e.results=null):t.results?(e.results=t.results,e.post=null):(e.results=null,e.post=null),(async e=>{if(e.paused)return;const t=new FormData;t.append("action","gpalab_feeder_next"),t.append("security",d()),i(t,"POST",(t=>{console.log("processQueue: ",t),B(e,t)}),(e=>{n(e,T)}))})(e)),t.results){const e=t.results.length>0?JSON.stringify(t.results,null,2):"No errors.";n(e,T)}else t.response},L=async(e,r)=>{const o=t(r?"Fixing errors...":"Initiating new resync.");E(!0,o),a(T),s(!0);const l=new FormData;l.append("action","gpalab_feeder_sync_init"),l.append("security",d()),l.append("sync_errors",r),l.append("method","GET"),u(l,"POST",(t=>{B(e,t)}),(t=>{w(e),n(t,T)}),I,12e4)},S=async()=>{const e="gpalab-feeder-output",r=document.getElementById("gpalab-feeder-url-input");E(!0,t("Testing connection...")),a(e),s(!0);const o=new FormData;o.append("action","gpalab_feeder_test"),o.append("security",d()),o.append("url",r.value),o.append("method","GET");const l=t=>{n(t,e)};i(o,"POST",l,l,(()=>{s(!1),E(!1)}))};(e=>{if("loading"!==document.readyState)return e();document.addEventListener("DOMContentLoaded",e)})((()=>{const e={total:0,complete:0,post:null,paused:!1,results:null};(e=>{const{syncTotals:t}=window.gpalabFeederSettings;e.total=parseInt(t.total,10),e.complete=parseInt(t.complete,10),e.paused=t.paused,e.paused&&(w(e),_(e.paused))})(e),(e=>{const t=document.getElementById("gpalab-feeder-clear-logs"),r=document.getElementById("gpalab-feeder-test-connection"),o=document.getElementById("gpalab-feeder-resync"),l=document.getElementById("gpalab-feeder-fix-errors"),c=document.getElementById("gpalab-feeder-resync-control"),i=document.getElementById("gpalab-feeder-validate-sync"),p=document.getElementById("gpalab-feeder-reload-log");t.addEventListener("click",m),r.addEventListener("click",S),o.addEventListener("click",(()=>L(e,!1))),l.addEventListener("click",(()=>L(e,!0))),c.addEventListener("click",c),i.addEventListener("click",(()=>(async e=>{a(T),_(e.paused),s(!0);const t=new FormData;t.append("action","gpalab_feeder_validate"),t.append("security",d()),u(t,"POST",(t=>{w(e),n(t,T)}),(t=>{w(e),n(t,T)}),I,12e4)})(e))),p.addEventListener("click",y),jQuery(document).on("heartbeat-send",f),jQuery(document).on("heartbeat-tick",v),h()})(e)}))}();